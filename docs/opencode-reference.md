# opencode Command Reference

The `opencode` command provisions and manages VPS instances pre-configured as
secured AI coding environments. Every server includes the opencode coding
assistant, a browser-based terminal, Avahi mDNS service discovery, and a
Caddy or Nginx reverse proxy — all configured via cloud-init at first boot.

---

## Synopsis

```
vpsm opencode <subcommand> [flags]
```

**Persistent flags** (apply to every subcommand):

| Flag | Description |
|---|---|
| `--provider <name>` | Cloud provider to use. Overrides the value set by `vpsm config set default-provider`. |

---

## Subcommands

### `opencode create`

Provisions a new opencode VPS on the configured cloud provider.

```
vpsm opencode create [flags]
```

#### Flags

| Flag | Default | Description |
|---|---|---|
| `--name <hostname>` | *(required)* | Server hostname. Used as the system hostname and the mDNS name (`<hostname>.local`). Must be a valid DNS label. |
| `--type <type>` | `cpx21` | Server type / instance size (e.g. `cpx11`, `cpx21`, `cx22`). See your provider's catalog for available types. A minimum of 2 vCPU / 4 GB RAM is recommended. |
| `--location <loc>` | *(auto)* | Datacenter location (e.g. `fsn1`, `nbg1`, `hel1`, `ash`). When omitted the provider picks a default. |
| `--image <image>` | `ubuntu-24.04` | Base OS image. Ubuntu 24.04 LTS is the only tested and supported image. |
| `--ssh-key <name>` | *(none)* | SSH key name or ID to inject (repeatable). Keys must already be registered with the provider. |
| `--proxy <type>` | `caddy` | Reverse proxy to install: `caddy` or `nginx`. |
| `--tailscale-key <key>` | *(none)* | Tailscale auth key (`tskey-auth-...`). When provided, Tailscale is installed and the server joins your tailnet, enabling MagicDNS access at `http://<hostname>/terminal`. |
| `--domain <fqdn>` | *(none)* | Public fully-qualified domain name (e.g. `dev.example.com`). **Caddy only** — Caddy will obtain a Let's Encrypt TLS certificate automatically. Ignored when `--proxy nginx` is set. |

When `--name` is omitted and the terminal is interactive, a step-by-step TUI
wizard launches to collect all options.

#### Output

On success the command prints:

- Server metadata (ID, status, region, type, image, public IP)
- Browser terminal URL: `http://<ip>/terminal`
- mDNS URL: `http://<hostname>.local/terminal`
- Tailscale URL (if applicable): `http://<hostname>/terminal`
- Domain URL (if applicable): `https://<domain>/terminal`
- SSH command to tail cloud-init logs

The server is usable after cloud-init finishes, typically **2–3 minutes** after
the API reports the server as running.

---

## What cloud-init installs

Every opencode VPS receives the following configuration on first boot via the
cloud-init `user_data` script generated by `vpsm opencode create`.

### Security

| Component | Configuration |
|---|---|
| **SSH** | Root login disabled. Password authentication disabled. Max auth tries: 3. Grace time: 30 s. Config applied via `/etc/ssh/sshd_config.d/99-hardening.conf` so the base config is not modified. |
| **UFW firewall** | Default deny incoming, allow outgoing. Open ports: `22/tcp` (SSH), `80/tcp` (HTTP), `443/tcp` (HTTPS), `5353/udp` (mDNS). |
| **fail2ban** | SSH jail enabled. Ban time: 1 h. Find window: 10 min. Max retries before ban: 5. |

### Service discovery

| Component | Details |
|---|---|
| **Avahi** | `avahi-daemon` is installed and started. An Avahi service file registers the web terminal as `_http._tcp` on port 80 at path `/terminal`. Hosts on the same L2 network (or the same Tailscale tailnet) can resolve `<hostname>.local`. |
| **Tailscale** *(optional)* | When `--tailscale-key` is provided, Tailscale is installed and `tailscale up` is called with the supplied auth key. MagicDNS resolves `<hostname>` for all devices on the tailnet. |

### Developer environment

| Component | Details |
|---|---|
| **opencode** | Installed globally via the official install script (`https://opencode.ai/install`). Falls back to `npm install -g opencode-ai` if the script fails. |
| **Node.js** | Node.js 20 LTS installed from the NodeSource PPA. |
| **ttyd** | Browser-based terminal (`https://github.com/tsl0922/ttyd`). Listens on `127.0.0.1:7681`. Runs as the `coder` user with `/home/coder/workspace` as the working directory. Registered as a `systemd` service. |
| **coder user** | Unprivileged system user created for the terminal and project work. Has `sudo` access to reload the reverse proxy config without a password. |
| **`~/deploy-project.sh`** | Helper script that copies a build directory into `~/www/<name>` so the reverse proxy immediately serves the project. See [deploy-project.sh](#deploy-projectsh). |

### Reverse proxy

#### Caddy (default)

Caddy is installed from the official Caddy apt repository.

| Path | Backend |
|---|---|
| `/terminal*` | Proxied to `ttyd` on `127.0.0.1:7681`. WebSocket connections are handled automatically. |
| `/*` | Served from `/home/coder/www` with directory listing. Projects deployed with `deploy-project.sh` appear here. |

When `--domain` is set, Caddy serves HTTPS on port 443 with automatic Let's
Encrypt certificates and redirects port 80 to HTTPS.

#### Nginx

Nginx is installed from the Ubuntu system repositories.

| Location | Backend |
|---|---|
| `/terminal/` | Proxied to `ttyd` on `127.0.0.1:7681`. Upgrade headers for WebSocket are set explicitly. |
| `/` | Served from `/home/coder/www` with `autoindex on`. |

Nginx does not support automatic TLS. The `--domain` flag has no effect when
`--proxy nginx` is used.

---

## `deploy-project.sh`

Located at `/home/coder/deploy-project.sh` on every opencode VPS.

```
~/deploy-project.sh <project-name> <build-directory>
```

| Argument | Description |
|---|---|
| `project-name` | Subdirectory name under `~/www/`. The project will be served at `http://<server>/<project-name>`. |
| `build-directory` | Path to the directory containing the built static files (e.g. `./workspace/myapp/dist`). |

The script replaces `~/www/<project-name>` atomically and sets world-readable
permissions so the reverse proxy can serve the files.

**Example:**
```bash
opencode "build me a React todo app in ./workspace/todo"
~/deploy-project.sh todo ./workspace/todo/dist
# → served at http://<server-ip>/todo
```

---

## mDNS access

Avahi advertises the web terminal via multicast DNS on the server's local
network interface. The `.local` hostname resolves automatically on:

- **Same datacenter private network** — other servers in the same Hetzner
  private network can reach `http://<hostname>.local/terminal`.
- **Tailscale tailnet** — when `--tailscale-key` is provided, the server joins
  your tailnet. All tailnet devices (including your laptop) can resolve
  `http://<hostname>/terminal` via Tailscale MagicDNS. This is the recommended
  approach for reaching an opencode VPS from a remote machine.
- **Local LAN** — if the server is on the same physical or virtual L2 segment
  as your machine (uncommon for cloud VPS), `<hostname>.local` resolves
  natively via mDNS.

Direct internet access by IP (`http://<public-ip>/terminal`) always works
regardless of network topology.

---

## Labeled resources

Every server provisioned by `vpsm opencode create` is tagged with the
following labels on the cloud provider:

| Label | Value |
|---|---|
| `managed-by` | `vpsm` |
| `role` | `opencode` |

Use these to identify opencode VPS instances in the provider dashboard or when
filtering with `vpsm server list`.

---

## Supported providers

`vpsm opencode create` delegates server creation to the standard provider
infrastructure used by `vpsm server create`. Any provider that implements
`domain.CatalogProvider` is supported. Currently:

| Provider | Status |
|---|---|
| Hetzner Cloud | Supported |

---

## Exit behaviour

The command exits non-zero when:

- No provider is configured and `--provider` is not set.
- The provider API returns an error.
- A required flag is missing in non-interactive mode (no TTY).
- The user cancels the interactive wizard.

All error messages are written to stderr; server details are written to stdout.
